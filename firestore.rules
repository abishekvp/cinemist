rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Allow read access to display puzzle
    match /displayPuzzle/{document} {
      allow read: if true;
      allow write: if request.auth != null; // Allow authenticated admins to rotate
    }
    
    // Allow read access to puzzle stats
    match /puzzleStats/{document} {
      allow read: if true;
      allow write: if true; // Allow public writes for stats tracking
      
      // Solver subcollection (used internally by functions)
      match /solvers/{solver} {
        allow read, write: if false; // Only Cloud Functions
      }
    }
    
    // Allow read and write access to active users
    match /activeUsers/{document} {
      allow read: if true;
      allow write: if true; // Allow public writes for presence tracking
    }
    
    // Waiting puzzles - allow create for submissions
    match /waitingPuzzles/{document} {
      allow read: if request.auth != null; // Allow authenticated admin users
      allow create: if true; // Allow public submissions
      allow update, delete: if request.auth != null; // Allow authenticated admin users
    }
    
    // Approved puzzles - admin only
    match /approvedPuzzles/{document} {
      allow read, write: if request.auth != null; // Allow authenticated admin users
    }
    
    // Rejected puzzles - admin only
    match /rejectedPuzzles/{document} {
      allow read, write: if request.auth != null; // Allow authenticated admin users
    }
    
    // History puzzles - read only for public
    match /historyPuzzles/{document} {
      allow read: if true;
      allow write: if request.auth != null; // Allow authenticated admins to archive
    }
    
    // History stats - read only for public
    match /historyStats/{document} {
      allow read: if true;
      allow write: if false; // Only functions
    }
  }
}
